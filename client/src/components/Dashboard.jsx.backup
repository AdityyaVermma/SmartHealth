import React, { useEffect, useState, useRef } from 'react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell, PieChart, Pie, Legend } from 'recharts';
import { Activity, AlertTriangle, MapPin, TrendingUp, Clock, ArrowRight, Droplets, Mountain } from 'lucide-react';
import { motion, animate } from 'framer-motion';
import { Link } from 'react-router-dom';
import neHeroImage from '../assets/ne_hero.jpg';
import HealthMap from './HealthMap';

const Counter = ({ from, to }) => {
  const nodeRef = useRef();

  useEffect(() => {
    const node = nodeRef.current;
    const controls = animate(from, to, {
      duration: 1.5,
      onUpdate(value) {
        node.textContent = value.toFixed(0);
      }
    });
    return () => controls.stop();
  }, [from, to]);

  return <span ref={nodeRef} />;
};

const Dashboard = () => {
  const [stats, setStats] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetch('http://localhost:5000/api/stats')
      .then(res => res.json())
      .then(data => {
        setStats(data);
        setLoading(false);
      })
      .catch(err => {
        console.error('Error fetching stats:', err);
        setLoading(false);
      });
  }, []);

  if (loading) return <div className="loading">Loading dashboard...</div>;
  if (!stats) return <div className="loading">Error loading data</div>;

  const chartData = Object.entries(stats.locations).map(([name, count]) => ({
    name,
    cases: count
  }));

  // Mock severity data
  const severityData = [
    { name: 'High', value: stats.highSeverity, color: '#ef4444' },
    { name: 'Medium', value: Math.max(0, Math.floor((stats.totalReports - stats.highSeverity) / 2)), color: '#f59e0b' },
    { name: 'Low', value: Math.max(0, Math.ceil((stats.totalReports - stats.highSeverity) / 2)), color: '#10b981' },
  ].filter(item => item.value > 0);

  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        staggerChildren: 0.1
      }
    }
  };

  const itemVariants = {
    hidden: { y: 20, opacity: 0 },
    visible: {
      y: 0,
      opacity: 1
    }
  };

  const cardHover = {
    y: -5,
    transition: { type: 'spring', stiffness: 300 }
  };

  return (
    <motion.div
      variants={containerVariants}
      initial="hidden"
      animate="visible"
    >
      {/* Hero Section */}
      <div className="hero-section" style={{
        backgroundImage: `linear-gradient(rgba(2, 44, 34, 0.7), rgba(2, 44, 34, 0.85)), url(${neHeroImage})`,
        backgroundSize: 'cover',
        backgroundPosition: 'center',
        padding: '6rem 2rem',
        borderRadius: '1.5rem',
        marginBottom: '3rem',
        textAlign: 'center',
        border: '1px solid rgba(255,255,255,0.1)',
        boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.2)'
      }}>
        <motion.div
          initial={{ y: -20, opacity: 0 }}
          animate={{ y: 0, opacity: 1 }}
          transition={{ delay: 0.2 }}
          style={{ display: 'inline-flex', alignItems: 'center', gap: '0.5rem', padding: '0.5rem 1rem', background: 'rgba(255,255,255,0.1)', borderRadius: '2rem', marginBottom: '1.5rem', border: '1px solid rgba(255,255,255,0.2)' }}
        >
          <Mountain size={16} color="#34d399" />
          <span style={{ color: '#d1fae5', fontSize: '0.9rem', fontWeight: 500 }}>Protecting Our Hills & Valleys</span>
        </motion.div>

        <motion.h1
          initial={{ y: -20, opacity: 0 }}
          animate={{ y: 0, opacity: 1 }}
          transition={{ delay: 0.3 }}
          className="page-title"
          style={{ fontSize: '3.5rem', marginBottom: '1.5rem', background: 'linear-gradient(to right, #ecfdf5, #34d399)', WebkitBackgroundClip: 'text', backgroundClip: 'text', WebkitTextFillColor: 'transparent' }}
        >
          Smart Health Northeast
        </motion.h1>
        <motion.p
          initial={{ y: 20, opacity: 0 }}
          animate={{ y: 0, opacity: 1 }}
          transition={{ delay: 0.4 }}
          className="page-subtitle"
          style={{ maxWidth: '700px', margin: '0 auto', fontSize: '1.25rem', lineHeight: '1.75', color: '#d1fae5' }}
        >
          Community-driven health monitoring for safer water and healthier villages across Northeast India.
        </motion.p>
      </div>

      {/* Regional Overview & Stats */}
      <div className="dashboard-grid">
        <motion.div variants={itemVariants} whileHover={cardHover} className="glass-panel card stat-card">
          <div className="stat-icon" style={{ background: 'rgba(16, 185, 129, 0.1)', color: '#10b981' }}>
            <Activity size={32} />
          </div>
          <div>
            <div className="stat-value"><Counter from={0} to={stats.totalReports} /></div>
            <div className="stat-label">Total Reports</div>
          </div>
        </motion.div>

        <motion.div variants={itemVariants} whileHover={cardHover} className="glass-panel card stat-card">
          <div className="stat-icon" style={{ background: 'rgba(239, 68, 68, 0.1)', color: '#ef4444' }}>
            <AlertTriangle size={32} />
          </div>
          <div>
            <div className="stat-value"><Counter from={0} to={stats.highSeverity} /></div>
            <div className="stat-label">Critical Cases</div>
          </div>
        </motion.div>

        <motion.div variants={itemVariants} whileHover={cardHover} className="glass-panel card stat-card">
          <div className="stat-icon" style={{ background: 'rgba(14, 165, 233, 0.1)', color: '#0ea5e9' }}>
            <Droplets size={32} />
          </div>
          <div>
            <div className="stat-value"><Counter from={0} to={Object.keys(stats.locations).length} /></div>
            <div className="stat-label">Monitored Villages</div>
          </div>
        </motion.div>
      </div>

      {/* Interactive Map */}
      <motion.div variants={itemVariants} style={{ marginBottom: '2rem' }}>
        <HealthMap />
      </motion.div>

      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))', gap: '2rem', marginBottom: '2rem' }}>
        <motion.div variants={itemVariants} whileHover={cardHover} className="glass-panel card">
          <div className="card-header">
            <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
              <div style={{ padding: '0.5rem', background: 'var(--bg-glass)', borderRadius: '0.5rem' }}>
                <TrendingUp size={20} color="var(--primary)" />
              </div>
              <h3 className="card-title">Village Health Status</h3>
            </div>
          </div>
          <div style={{ height: '300px' }}>
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={chartData}>
                <CartesianGrid strokeDasharray="3 3" stroke="var(--border-color)" vertical={false} />
                <XAxis
                  dataKey="name"
                  stroke="var(--text-muted)"
                  tick={{ fill: 'var(--text-muted)' }}
                  axisLine={false}
                  tickLine={false}
                />
                <YAxis
                  stroke="var(--text-muted)"
                  tick={{ fill: 'var(--text-muted)' }}
                  axisLine={false}
                  tickLine={false}
                />
                <Tooltip
                  contentStyle={{
                    backgroundColor: 'var(--bg-card)',
                    border: '1px solid var(--border-color)',
                    borderRadius: '0.5rem',
                    color: 'var(--text-main)'
                  }}
                  cursor={{ fill: 'var(--bg-glass)' }}
                />
                <Bar dataKey="cases" radius={[4, 4, 0, 0]}>
                  {chartData.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill="url(#colorGradient)" />
                  ))}
                </Bar>
                <defs>
                  <linearGradient id="colorGradient" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0%" stopColor="var(--primary)" stopOpacity={1} />
                    <stop offset="100%" stopColor="#0ea5e9" stopOpacity={0.8} />
                  </linearGradient>
                </defs>
                backgroundColor: 'var(--bg-card)',
                border: '1px solid var(--border-color)',
                borderRadius: '0.5rem',
                color: 'var(--text-main)'
                  }}
                />
                <Legend />
              </PieChart>
            </ResponsiveContainer>
        </motion.div>
    </motion.div>
      </div >

  {/* Community Actions and Updates */ }
  < div style = {{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(350px, 1fr))', gap: '2rem', marginBottom: '2rem' }}>
        <motion.div variants={itemVariants} whileHover={cardHover} className="glass-panel card">
          <div className="card-header">
            <h3 className="card-title">Community Actions</h3>
          </div>
          <div style={{ display: 'grid', gap: '1rem' }}>
            <Link to="/report">
              <motion.div
                className="btn btn-primary"
                style={{ justifyContent: 'space-between', width: '100%' }}
                whileHover={{ scale: 1.02 }}
                whileTap={{ scale: 0.98 }}
              >
                Report Issue <ArrowRight size={18} />
              </motion.div>
            </Link>
            <Link to="/alerts">
              <motion.div
                className="btn"
                style={{ background: 'var(--bg-glass)', border: '1px solid var(--border-color)', justifyContent: 'space-between', width: '100%' }}
                whileHover={{ scale: 1.02 }}
                whileTap={{ scale: 0.98 }}
              >
                Check Alerts <ArrowRight size={18} />
              </motion.div>
            </Link>
          </div>
        </motion.div>

        <motion.div variants={itemVariants} whileHover={cardHover} className="glass-panel card">
          <div className="card-header">
            <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
              <Clock size={20} color="var(--text-muted)" />
              <h3 className="card-title">Regional Updates</h3>
            </div>
          </div>
          <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
            <motion.div
              initial={{ x: -20, opacity: 0 }}
              animate={{ x: 0, opacity: 1 }}
              transition={{ delay: 0.5 }}
              style={{ display: 'flex', gap: '1rem', alignItems: 'center', paddingBottom: '1rem', borderBottom: '1px solid var(--border-color)' }}
            >
              <div style={{ width: '40px', height: '40px', borderRadius: '50%', background: 'rgba(16, 185, 129, 0.1)', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                <MapPin size={20} color="#10b981" />
              </div>
              <div style={{ flex: 1 }}>
                <div style={{ fontSize: '0.95rem', fontWeight: 600 }}>Safe Water Campaign in Assam</div>
                <div style={{ fontSize: '0.85rem', color: 'var(--text-muted)' }}>New filtration units installed in 5 villages.</div>
              </div>
              <div style={{ fontSize: '0.8rem', color: 'var(--text-muted)' }}>2h ago</div>
            </motion.div>
            <motion.div
              initial={{ x: -20, opacity: 0 }}
              animate={{ x: 0, opacity: 1 }}
              transition={{ delay: 0.7 }}
              style={{ display: 'flex', gap: '1rem', alignItems: 'center', paddingBottom: '1rem' }}
            >
              <div style={{ width: '40px', height: '40px', borderRadius: '50%', background: 'rgba(14, 165, 233, 0.1)', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                <Droplets size={20} color="#0ea5e9" />
              </div>
              <div style={{ flex: 1 }}>
                <div style={{ fontSize: '0.95rem', fontWeight: 600 }}>Monsoon Preparedness</div>
                <div style={{ fontSize: '0.85rem', color: 'var(--text-muted)' }}>Alerts issued for low-lying areas in Meghalaya.</div>
              </div>
              <div style={{ fontSize: '0.8rem', color: 'var(--text-muted)' }}>5h ago</div>
            </motion.div>
          </div>
        </motion.div>
      </div >
    </motion.div >
  );
};

export default Dashboard;
